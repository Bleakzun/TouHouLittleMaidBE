
-----

【女仆系统】
## 完成

#### 物品

 - 魂符、相机、照片、胶片、三种背包（手持背包shift右键换包）
 - 合成配方：复活、召唤、照相机
 - 记忆中的幻想乡第一章-总览
 - 记忆中的幻想乡第二章-祭坛合成

#### 本体
 - 跟随模式：家、跟随玩家
 - 工作模式：空闲、近战、弹幕攻击、农场
 - 拾物模式
 - 自动回血：6秒回复一次，等级越高回复量越大
 - 背包显示开关
 - 照片、魂符和胶片召唤的女仆只有原主人可以驯服
 - 照片和魂符生成的女仆可以由苹果和蛋糕驯服，且成功率100%
 - 等级：随着等级的升高，回血速度、血量、近战及远程（弹幕）攻击力、防御力都会增加。
 - NPC：驯服后使用NPC工具交互可以使女仆转换成NPC，手持NPC工具攻击即消除NPC女仆。站立位置和模型应在转换前就选好。最好是用白板女仆变，否则可能会出问题。
  
#### 外观
 - 背包渲染
 - 模型包的转换与加载
 - 基本的动画，只适用于经典女仆模型
 - 基本表情显示

#### 弹幕
 - 玩家发射的弹幕无法伤害自己的女仆和坐骑。
 - 女仆发射的弹幕无法伤害主人以及主人相同的女仆。

#### 其它
 - 配置
   - 显示当前配置 /scriptevent thlm:config show
   - 修改配置项 /scriptevent thlm:config danmaku_damage:600

#### 环境声音

    mob.thlmm.maid.death        自动触发
    mob.thlmm.maid.find_target
    mob.thlmm.maid.hurt_player
    mob.thlmm.maid.hurt         受伤  自动触发
    mob.thlmm.maid.item_get   每捡一次物品就发生有点太吵了，需要设置冷却时间
    mob.thlmm.maid.tamed        拐骗成功  行为包触发

    mob.thlmm.maid.cold     1 
    mob.thlmm.maid.hot      2 
    mob.thlmm.maid.rain     3 
    mob.thlmm.maid.snow     4 

    mob.thlmm.maid.morning     早安  行为包触发
    mob.thlmm.maid.night       晚安  行为包触发

    mob.thlmm.maid.attack      攻击模式  行为包触发 切换模式时
    mob.thlmm.maid.feed        喂养模式  行为包触发 切换模式时
    mob.thlmm.maid.idle        休息模式  自动触发 存在频率过高的问题

    mob.thlmm.maid.credit
  为了使用静音模式，以后应该都会改成脚本触发

## 计划

添加管理指令，查看和更改魂符、女仆的信息等。

*回血数字
*女仆背包内物品进入箱子的方式。九宫格存在绑定问题，不太好实现；隙间容易做，但是需要增加饰品功能。
*相册（如果lore没有上限或者在装满的状态不会溢出，可以考虑加一个）
*背包UI（目前不改也能用）
*黄金微波炉的音效
*弹幕的架构设计存在缺陷，不能很好地同时处理默认弹幕与自定义弹幕。考虑为 默认弹幕 和 自定义弹幕 的实体专门建类，发射时根据类型用它们来构造实体，然后用相同的方法发射。

------------------

长期计划
*（特色）好感度。到达一定值可以解锁cosplay服装、专属武器合成配方、支援弹幕（类似地灵殿，会自动攻击玩家攻击的实体）。互动、赠送礼物可以升高，均有冷却时间；战死、过度工作则会降低。
*（特色）学习。学习可以获得经验值，提高等级从而做更多事情，掌握更多技能（如解锁弹幕攻击方式）
*（方案）使用实体菜单进行模式选择，为保证准确性，只有静止时才能有效点击。即在坐下状态下菜单才会展开。
*（特色）幻翼鲨手模式：大功率发射只伤害幻翼的弹幕
*（注意）女仆的实体定义需要一个模板和更新脚本，因为一些女仆可能需要分开定义。
拟定的结构：thlmm:maid_define_xxx使用variant定义所有的女仆实体，然后在脚本里设置特定variant对应的特殊女仆命名空间，在variant变更时会检测是否为特殊定义，若是则发生转变。
    特殊定义的格式为 thlmm:maid_special_xxx
增加技能系统，女仆可以习得多种技能并装备其中的有限个，攻击时能积累技能点，达到需求即可释放技能。
  可以自动释放，也可以由玩家使用远程法杖手动释放
  技能分 攻击、防御、辅助等，各种类型的技能有装备上限和使用冷却
    攻击：使用特殊的攻击模式对目标发起攻击（如特殊弹幕）
    防御：加强对物理或魔法攻击的减免（技能防御不能完全减免）
    辅助：加强物理或魔法攻击的伤害、提高移速、隐身等

模式选择图标：
+    空闲        羽毛    items/feather.png
+    近战攻击    钻石剑  items/diamond_sword.png
+    弓兵        弓      items/bow_standby.png
+    弹幕攻击    御币     items/hakurei_gohei.png
+    农场        铁锄    items/iron_hoe.png
+    幻翼杀手    幻翼膜   items/phantom_membrane.png
（加号是第一轮实现的模式）
*    甘蔗        甘蔗     items/reeds.png
*    瓜类        西瓜片   items/melon.png
*    可可        可可豆   items/dye_powder_brown.png
*    花草        单层草   items/tallgrass.png
*    清雪        雪球     items/snowball.png
*    喂食        熟牛排   items/beef_cooked.png
*    剪刀        剪刀     items/shears.png
*    牛奶        牛奶     items/bucket_milk.png
*    火把        火把     items/torch_on.png
*    繁殖动物    小麦     items/wheat.png
*    灭火        灭火器   items/extinguisher.png
*    钓鱼        鱼竿

得研究一下子包怎么做，还有脚本能不能共用，以提高可拓展。

-----

【实体菜单】（或许会使用普通表单）
  女仆的背包界面使用基础物品栏，可能可以从npc的ui借用一个模型预览组件
  切换模式的操作就得用有多种选项的菜单了。拟定实现方案：
  参考minecar，实现物品界面和按钮界面两种交互结果

> 架构（自顶向下）
  js脚本层提供一个创建表单的接口，可以创建按钮并指定它们的位置、被点击后执行的函数。

  实体层接收玩家的攻击，并将信号传递给脚本层。能够触发事件的应该只有被指定的玩家。实体事件传给脚本之后只剩下很少的信息，所以要尝试在数驱部分做检测，或者转而监听实体受击事件。若监听受击，则应该只在菜单展开时监听，否则会造成较大的性能占用。

> 选项实体  
  选项实体有一个动态属性，用于记录调出者的id，无重力，无视所有攻击，在受击时会触发事件。
  每个选项均有两种状态，选中与未选中。选中时会额外显示绿色边框。
  选项是可被命名的，被指向时，会展示字幕。
  所有选项实体均由产生菜单的主体控制，并有自毁倒计时，主体会定时激活选项实体的事件将其倒计时清零。
  实体的命名空间以"thlmm:"(touhou little maid menu)作为前缀。

> 菜单项：
命名空间分配（xx是两位数字）：
  一级菜单：maid_main_xx
  二级菜单（按功能命名）：maid_mode_xx、maid_status_xx
  按钮：确认、取消、返回、上一页、下一页

-----

【祭坛合成与P点系统】
（待完善）用entity_sensor（使用例见女仆）代替脚本进行扫描
*（待修复）新版本中手上没有物品则不会触发beforeItemUseOn事件，导致空手取下祭坛上的物品失效，需要另寻它法。目前不是很急，因为可以跳起来取。
（待加入）庭灯：可以存储P点，打掉之后P点会以lore的形式存储在物品之中（需要测试lore中是否能包含translate文本）
（待完善）参考Philip枪械模组的弹药显示，使用动画优化p点显示，避免不停扫描主手物品。

-----

【弹幕系统】
（待完善）修改符札弹渲染方案，角度朝向运动方向，自转跟随加速度方向
（待完善）弹幕的inaccuracy与java保持一致
（待完善）妖精女仆发射弹幕时播放雪球声音
（待完善）用mark_variant或直接播放缩放动画来设置缩放倍率scale。()
（待加入）冲击炸弹 冲击效果非常强，伤害一般
（待加入）判定点。受击时计算与玩家的距离，在范围内才触发伤害。潜行时显示虚化身体骨骼并显示判定点（可选，因为可能与别的addon不兼容）。
（待加入）参考凋灵风暴制作魔炮,外层混合内层发光。
（待加入）实体不会被同组弹幕击伤。弹幕编组tag前缀：tdg，如tdgxxx （touhou danmaku group）。为提高性能，弹幕自身和玩家的编组靠动态属性标记。
    受击判定时，若找不到发射实体，则查看弹幕是否被标记。不过目前还没有无发射者的弹幕，估以后也不会有。
（待加入）八卦炉：长按即可发射，不同发射模式有不同的发射时长上限和冷却时间（PS 消耗耐久然后自动回复也行，更像能量消耗），一旦发射能量耗尽就会进入对应的冷却阶段。发射模式：低火力星弹、高火力星弹、激光、魔炮；在扫帚上使用能加速。
（待完善）试验伤害（damage）是否能为小数，若是，则更新entitydanmaku和danmakushoot的setDamage参数为Float


（待加入）basic弹幕：激光。利用scale随时间变化达到无限长度射击的效果，击中目标后，激光会停止拉长并立即消失。或许可以射出实际的、透明的战斗部，然后用粒子效果展现激光。
（待加入）Advanced弹幕：达到某一条件（如速度、位置、触地、击中）后就触发事件的弹幕。  发射一枚斜向上的弹幕，
（待加入）自定义弹幕：命名时用“custom”和原先的basic组分开。
（待加入）Advanced弹幕：编组弹幕。在生成后会召唤出基础弹幕，随后操控它们的运动状态。如灵乌路空的原子模型
（待加入）Advanced弹幕：阴阳玉。触地反弹。
（待加入）Advanced弹幕：追踪符札：[ 纸×3 + 火药 + 炸药/药水/纸 ] 在祭坛消耗0.5P点合成 [ 符札×8 ]。符札会自动追踪发射时瞄准的实体，若发射时视线上没有实体，则获取一定范围内的所有生物，计算它到视线（一根线段）的距离，符合条件则寻找折线路径；若没有找到，则自行寻找运行方向上最近的敌对生物；基础伤害等于力量4的弓射出的箭，第三项合成材料为药水时会附带对应的药水效果，时长同药水箭，为炸药时造成范围伤害，为纸时仅造成基础单体伤害。
（待加入）魔炮：激活后立即让玩家骑上一个技术性实体，玩家可以通过视角变换来调整发射方向，方向键调整自己和发射点位置，蓄力时可以以较快的速度改变角度和发射点，而开始轰击后就只能以非常缓慢的速度调整了


（待加入）冈格尼尔：高级三叉戟。
（待加入）支持多种欧拉角旋转次序
（待完善）加入可设置的重力：因为不能动态设置重力，采用跃迁式的设置方式，0-1，每0.1设一段，向上取整地设置重力
（待完善）可设置的变向变力：提供两个函数接口： 方向随时间变化的函数 和 大小随时间变化的函数。为性能考虑，在生成该类弹幕后会保留对其的引用，每游戏刻主动修改其动量。
（待完善）可设置的运动轨迹：提供一个函数接口： 弹幕位置随时间变化的函数。 为性能考虑，在生成该类弹幕后会保留对其的引用，每游戏刻主动修改其动量。
    计算方法是先算出下一游戏刻应该处于的位置，然后计算要到达该位置应有的动量，最后将动量设置为应有的动量。设置有两种方法，一种是清空直接设置，另一种是在原有基础上叠加，需要测试二者的性能谁更强。
PS：变向变力与运动轨迹均可以选择世界坐标和相对坐标。
*（待完善）各弹种的判定范围（可能无法实现）
PS：角色的特色武器可以设定为无法合成，只能在对应女仆好感度达到一定等级时获取。
PS：大多数stg符卡都较难作为玩家发射的弹幕，因为指向性不强，效果可能不如被怪物释放
用q.get_name制作命名彩蛋

（无法完善）给御币加上使用周期，从而取消食物动画。虽然食物动画取消了，但手部动画也没了，其它玩家看不出是不是在蓄力，要增加动画的判定则要修改player相关的文件，会降低兼容性。


-----
【boss生物】
~~计划利用末影龙变体和附着物实现无限距离加载~~
切赛德
魔理沙（符卡还原相对简单）
藤原妹红（时间陷阱可用）

模仿植物魔法boss，搭建场地才能召唤，且有冷却时间。
boss只会受到来自女仆的攻击，并且只会攻击女仆。玩家可以在场内通过远程法杖指挥女仆走位和攻击。
限制场内的女仆数量，超限的女仆会被变成物品。

-----

【其它】

*（未使用）闪烁贴图：见danmaku_basic render的注释部分
*（费力见效少）使用ui制作记忆中的幻想乡。
* 扫帚，玩家坐上去之后视角向上按前进就可以飞，参考minecar的飞行矿车。
坐垫功能化
  使用村民交易制作每天刷新新交易的电脑，电脑可以购买其它功能物品
数字显示参考 https://mcpedl.com/damage-count/
* 通过修改下拉列表实现无停顿的操作。玩家点击按钮只是选择了某个选项，最终关闭表单时选择才会生效。
