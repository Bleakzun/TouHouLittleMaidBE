

------------------

#### 大批量数据传输方案

要提供外部配置方法，不然每次更新都要改配置，很麻烦
考虑预留一个函数，让外部行为包定义它，调用scriptevent传值，每次世界加载时自动调用。
每个信息的最大长度为2048，所以有些信息可能要分多次发送，于是定义每条信息如下：
    信息组ID:总条数:当前条:内容（字符串）
    如："1:5:0:string_message"
    脚本会接收指定事件，在接收到了某组信息的全部信息时，将它们组装起来供其它模块使用。

------------------

#### 交互设计

  右击：坐
  左击：打开菜单
  潜行右击：打开背包
  潜行手持背包右击：切换背包

------------------

#### 关于背包

  因为女仆的物品栏还要用作种植、装护甲，物品不能总是放实体背包，实体背包只是供玩家交互的。
  利用只有潜行才能与背包交互的特性，进入潜行时，将女仆包内的物品剪切进背包，护甲、饰品及手上的物品复制进背包
  退出潜行时，背包物品放回女仆背包，装备则更新信息

------------------

#### 表情显示

展示不同的表情不难，用一个int属性即可。
但是若要设置动态表情的播放速度就需要特别设计一下了。用脚本自然是很方便的，但是会占用宝贵的属性条目，需要尝试使用 variable 等资源包手段控制。
考虑对特殊处理，然后取模得到动画速率。
属性值的取值范围是 -2147483648, 214 748 3647，正好可以让正数作为表情索引，负数作为速率！
至于贴图动画的偏移量，用基于贴图大小的操作：
    "offset": [
        0.0,
        "math.mod(math.floor(query.life_time * 0.5),4) / 4"
    ],
    "scale": [
        1.0,
        "1 / 4"
    ]
序列帧的数量又需要传递了... 很想再加个取模传值的操作。
就用取模。所谓“速率”实际上是指多少游戏刻一帧，这个值不太可能超过999，超过了就和静态的差不多了，如法炮制，无需多次传值，只要将三个数合并到一个数里即可。
2147483647 是十位数，大端满不了9需要注意，按速率，帧数，序号的顺序分配：
2 147 483 647
三个数各1k，非常够用了。
比如3号表情有5个序列帧，速率为10，则表示为 10,005,003
emote_index  emote_frame  emote_speed

------------------

#### 关节朝向实体运动方向

原版箭朝向运动方向是硬编码，且无法通过 runtime identifier 添加。

*资源包实现
只需要对欧拉角 z x 旋转，即可得到任何想要的方向。
为了表示方便，设运动方向为(x,y,z)
为了计算方便，设骨骼初始朝向为(1,0,0)
先算出 y-x 平面上旋转的角度，即 z 值，再算出 x 值
下面是将x值近似为x-z平面旋转角度的资源包实现，实际测试中骨骼并没有旋转，可能是movement_direction的获取出了问题。文档中注明这个值与鞘翅有关，猜测是只有鞘翅能获取这个值。
"rotation": ["(180/3.14)*math.atan2(query.movement_direction(2), query.movement_direction(0))", 0, "(180/3.14)*math.atan2(query.movement_direction(1), query.movement_direction(0))"]

*行为包实现
可以添加 thlm:r_x/z 属性，直接设置旋转量。

------------------

#### 穿透射击

实体受击事件是串行处理的，只穿透实体问题不大
但是既穿方块又穿实体就会出现问题。方块的击中事件是在实体之后处理的，弹速很快时就会无视方块数量造成伤害。
并且击中方块事件能检测到的方块并不是所有被穿透的方块，这意味着弹幕在穿过一段距离之内的所有方块后才会将穿透计数器减一
如此，我们只能 **在发射前就检测路径上的实体与方块** ，计算实体是否能被击中。

------------------

#### 追踪射击/雷电射击

追踪/弧线射击可以分为两个核心步骤，一是索敌，二是寻路。

- 索敌
  对于玩家，采用圆锥检测，因为射线检测消耗性能较大且不能穿墙，这里使用多个球来近似圆锥。
  对于非玩家，索敌是由数驱进行的，

- 雷电射击的寻路
  寻路主要有三个要素：偏转次数、偏转速度和行进距离。
    偏转次数：为渲染考虑，每一段雷电都需要渲染出来；为寻路考虑，过多偏转次数会消耗大量算力，所以段数不能太多。
    偏转速度：每次偏转时方向变化角度的最大值。
    行进距离：路径总长度的限制。
  
  按现实理论，只要介质允许，闪电可以任意角拐弯，问题就转化成了在两点之间寻找不通过方块的折线路径。
  但是实际上自然闪电很少走回头路，并且全方向扫描会消耗大量性能，所以将转向角约束在45度以内。

- 射线穷举法
  - 由起点出发，沿着到终点的连线射出一道搜索射线，碰到了方块
    将起点设在命中点前的1格，偏转45度，向八个方向发射搜索射线，重复之前的步骤，直到回到发射点前一格之内。
    每次确定发射点时，都向目标点发射一条检测射线，若能射中目标，则搜索结束，得到路径。
  - 为了使线路偏转角度尽可能小，在找到路径后，会从起点到终点优化路径，即寻找距离起点更近偏转点。
  - 穷举方法简单可行，但是性能肯定是有待提高的。有没有更好的方法？
  
  - 优化分析
    - 优化方向 1：目标点是已知的，是否存在一种方法，能让起点和终点一起开始搜索？
      首先可以确定的是，若还是使用射线搜索法，要使起点和终点一起搜索更快，则第一次碰撞一定不能是同一个方块，否则就成了两个十分对称的搜索，会有很多多余步骤。
      起点和终点一起同步发射射线，起点侧每次确定发射点时的检测射线改向终点的未确定点，这样能够从终点排除一些点，从而使搜索更快收敛。

    - 优化方向 2：射线的偏转很机械，是否存在一种更优秀的偏转方案？
      现在考虑的是先碰到方块，再由方块向发射位置寻找偏转点，如果反过来，从发射位置向方块寻找偏转点，是否更为高效？
    
    - 优化方向 3：射线搜索相当于将方块位置视为未知，但实际上方块都是已知的。在经典寻路算法的基础上寻找折线路径的性能是否比射线法的更高？
      这一方法相比射线法，可能会多出一些获取方块的开销。但射线法同样也需要获取方块，想到这里，我决定先实现经典寻路算法。

- 经典寻路算法（A*、JPS 等）
  经典寻路算法基于网格，确定一个长方体的寻路范围能有效地减少寻路步骤。
  因为是一格一格走的，目标点的距离不能太远，否则就会消耗大量算力。

- 单折射线
  经测量，射线寻方块的速度是 0.03ms/次，坐标寻方块的速度约为 0.01ms/次
  mc的一刻是 50ms，尽量压缩到 5~10ms 完成寻路，即 167 ~ 334 次射线，极限1667次。

  基于射线穷举法的思想，将偏折次数限定为1，实现更步骤更少的寻路。

  需要解决的场景：
    直线路径上存在方块，且改变发射角度不能抵达与紧挨该方块的方块
  
  拟定方案一：
    假设发射点到目标点的直线路径被一个方块 B 阻挡
    基于发射点到目标点的向量 α ，旋转出一条新的向量，从而通过射线检测得到一个方块（也可能没有）
      若有方块，则以发射点和方块为两端点，若没有方块，则以发射点到目标点的距离确定另一个端点，从而得到一条线段。
      让目标点射出与该线段相交的射线，若没有被阻挡，则得到路径

    新向量的确定是需要解决的问题，提出以下方案：
      - 方案一：过阻挡点 B 建立与 α 垂直的平面，以 B 为中心，建立宽为 1 的网格，网格遍布指定半径的圆形区域，由发射点指向格点，建立向量。
        这么做可以使搜索次数稳定在一个设计值附近，但是在距离较远时，还能作更大的偏转，虽然动态设置半径也可行，但是会增大性能消耗，需要设置上限。
         ps 也不一定要过阻挡点，过中点反而更稳定
      - 方案二：无视距离，建立固定的网格，其它同方案一。
    
    无效性判断可能会需要非常多的步骤，在这里特别分析一下：
      在目标点射出与线段相交的射线时，应该从靠近目标点的端点开始
      ☆ 通过记录碰撞表，将找到的方块记录下来，避免重复射同一个方块。碰撞表先进先访问，因为先进的方块更有可能被碰撞。
      二分法或许能更好地适应各种长度。
  
  拟定方案二：
    以发射点和目标点为起点，以两点连线为中轴线，在锥体范围内对称地引出若干条射线。
    逐射线地获取方块，若命中方块则计算折线长度，同时计算其它命中该方块的线段长度，这一步是为了减少重复的取方块操作，至多需要计算三个面。
    一条发射点射线对应的目标点射线是可以确定的，并且都在一个平面内，根据目标点射线长度判断其是否与发射点射线相交，若相交则完成搜索。

------------------

#### 弹幕设计

普通的直线/曲线等一眼就能看出运动轨迹甚至实现方法的弹幕略显枯燥，「图案」可以成为一个提高观赏性的工具，而做出瞬发的图案需要对应的外部生成工具。


