<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="utf-8" content="text/html; charset=GBK">
        <meta name="viewport" content="width=device-width">
        <title>车万女仆模型包转换器</title>
    </head>
    <body>
        <h1>车万女仆模型包转换器</h1>
        <p>一个将Java版女仆模型包转换为基岩版的工具。</p>
        
        <hr>

        <p> <b>UUID</b>  </p>
        <div style="text-indent: 10px;">
            <p>UUID是模型包的唯一标识符，你可以在 <a href="https://www.uuidgenerator.net" target="_blank" title="UUID生成">网站</a> 获取它。</p>
            <div><label for="uuid">输入UUID：</label> <input id="uuid" type="text"></div>
        </div>

        <p><b>Java版模型包</b></p>
        <div style="text-indent: 10px;">
            <p>
                在 <a href="http://page.cfpa.team/MaidCustomPack/zh" target="_blank" title="模型下载">模型下载</a> 
                页面下载Java版女仆模型包，然后点击「添加」按钮上传zip文件。
            </p><p>
                模型包前方的序号决定在游戏内的先后顺序，
                如果已经在世界中使用了模型包，请使序号保持一致。
            </p>
            
            <div>
                <table border="1" style="margin-inline:10px;" id="result_block">
                    <tr><th>序号</th><th colspan="2">信息</th></tr>
                    <tr><td align="center">*</td><td colspan="1">待上传</td></tr>                    
                </table>
                <input type="file" id="file" name="file" style="padding:10px;" multiple/>
            </div>
        </div>
        
        <hr>
        <button onclick="startConvert()" id="b_convert">开始转换</button>

        <!-- 样式 -->
        <style type="text/css">
            table td{padding:5px;}
        </style>
        <script src="jszip.js"></script>
        <script src="FileSaver.js"></script>
        <!-- 主要处理 -->
        <script type="text/javascript">
            //// 模板 ////
            const tmp = {
                manifest: {
                    "format_version": 2,
                    "header": {
                        "name": "TouHou Little Maid - Skin Pack",
                        "description": "Skin Pack of TouHou Little Maid",
                        "uuid": "<uuid>",
                        "version": [ 1, 0, 0 ],
                        "min_engine_version": [ 1, 20, 30 ]
                    },
                    "modules": [
                        {
                            "type": "resources",
                            "uuid": "b283624d-5a73-4f82-9ea4-9a1f50eeb0ab",
                            "version": [ 1, 0, 0 ]
                        }
                    ],
                    "dependencies": [],
                    "subpacks": []
                },
                languages: ["de_DE","en_US","es_ES","fr_FR","it_IT","ja_JP","ko_KR","pt_BR","pt_PT","ru_RU","tr_TR","zh_CN"],
                render_controller: {
                    "format_version": "1.8.0",
                    "render_controllers": {
                        "controller.render.touhou_little_maid.maid_<pack_name>": {
                            "arrays": {
                                "textures": {
                                    "Array.skins": [
                                        "Texture.void"
                                    ]
                                },
                                "geometries": {
                                    "Array.geos":[
                                        "Geometry.void"
                                    ]
                                }
                            },
                            "geometry": "Array.geos[q.property('thlm:skin_pack')==<index>?q.property('thlm:skin_index')+1:0]",
                            "materials": [
                                {"*": "Material.default"},
                                {"wingLeft": "Material.wing"},
                                {"wingRight": "Material.wing"}
                            ],
                            "textures": [ "Array.skins[q.property('thlm:skin_pack')==<index>?q.property('thlm:skin_index')+1:0]" ]
                        }
                    }
                },
                entity: {
                    "format_version": "1.10.0",
                    "minecraft:client_entity": {
                        "description": {
                        "identifier": "thlmm:maid",
                        "textures": {
                        },
                        "geometry": {
                        },
                        "render_controllers": [
                            "controller.render.touhou_little_maid.maid.maid_backpack",
                            "controller.render.touhou_little_maid.maid_touhou_little_maid"
                        ]
                        }
                    }
                }
            }

            //// 文件列表 ////
            var fileList = []; // [ {"name":"xxx.xx"} ]
            var processing = false; // 正在处理

            //// 添加文件事件 ////
            const fileUploader = document.getElementById('file');
            fileUploader.addEventListener('change', (event) => {
                const files = event.target.files;
                for(let i = 0; i < files.length; i++){
                    fileList.push(files[i]);
                }
                
                // console.log('files', files);
                // console.log('fileList', fileList);

                // 更新列表
                refreshList();
            });
            function refreshList(){
                if(processing) return;
                const res = document.getElementById('result_block');
                let msg = `<tr><th>序号</th><th colspan="2">信息</th></tr>`;
                for(let i = 0; i < fileList.length; i++){
                    msg += `<tr><td align="center">${i+1}</td>`; // 序号 0为默认包预留
                    msg += `<td>${fileList[i].name}</td>`; // 文件名
                    msg += `<td><button onclick='file_up(${i})'>↑</button> <button onclick='file_down(${i})'>↓</button> <button onclick='file_del(${i})'>x</button></td></tr>`
                }
                res.innerHTML = msg;
            }
            
            //// 改变文件位置 ////
            function file_up(num){
                if(num == 0 || processing) return;
                var temp = fileList[num-1];
                fileList[num-1] = fileList[num]
                fileList[num] = temp;
                refreshList();
            }
            function file_down(num){
                if(num >= fileList.length - 1 || processing) return;
                var temp = fileList[num+1];
                fileList[num+1] = fileList[num]
                fileList[num] = temp;
                refreshList();
            }
            function file_del(num){
                if(processing) return;
                fileList.splice(num, 1);
                refreshList();
            }

            //// 转换并输出 ////
            function startConvert(){
                if(processing) return;
                console.log("Start converting..");
                /// 信息完整性判断 ///
                if(fileList.length<=0){
                    alert("请上传Java版模型包")
                    return;
                }
                let uuid = document.getElementById("uuid").value;
                if(uuid == ""){
                    alert("请输入uuid")
                    return;
                }

                /// 停止页面交互 ///
                processing = true;
                document.getElementById("b_convert").disabled = true;
                document.getElementById("file").disabled = true;

                /// 开始处理 ///
                let result = new JSZip();
                // 生成 manifest.json
                {
                    let manifest = JSON.stringify(tmp.manifest, null, '\t');
                    manifest = manifest.replace("<uuid>", uuid);
                    result.file("manifest.json", manifest);
                }
                // 创建公共语言文件 lang/xxx 处理完成后会删除空文件并根据模板定义文件 languages.json
                var lang_folder = result.folder("lang");
                for(let lang_name of tmp.languages){
                    lang_folder.file(`${lang_name}.lang`, "");
                }

                // 遍历输入文件，生成信息
                var models = result.folder("models").folder("entity"); // models/entity/xxx/    女仆模型
                var textures = result.folder("textures");      // 贴图文件夹
                var textures_icon = textures.folder("thlm");   // 模型包图标
                var maid_entity = tmp.entity;                  // entity/maid.entity.json    模型信息
                var render_controller = tmp.render_controller; // ender_controllers/maid.json  渲染方案
                
                for(let i = 0; i < fileList.length; i++){
                    JSZip.loadAsync(fileList[i]).then(function(zip) {
                        // 移动图标
                        zip.files["pack.png"].async("Blob").then(function success(content) {
                            textures_icon.file(`pack_pack_${i+1}.png`, content);
                        });
                        
                        // 处理 assets 文件
                        var s_textures = [];
                        var s_models = [];
                        var s_lang = [];

                        // 获取中间文件夹名称
                        var packName = "a";
                        for(let file in zip.files){
                            let folder_list = file.split('/');
                            if(folder_list.length === 3 && folder_list[2] === ""){
                                packName = folder_list[1];
                                break;
                            }
                        }
                        
                        // 移动女仆图标
                        zip.files[`assets/${packName}/textures/maid_icon.png`].async("Blob").then(function success(content) {
                            textures_icon.file(`pack_maid_${i+1}.png`, content);
                        });
                        
                        // 移动女仆贴图
                        var pack_textures = textures.folder(packName);
                        zip.folder(`assets/${packName}/textures/`).forEach(function (path, file){
                            if(path !== "maid_icon.png"){
                                file.async("Blob").then(function success(content) {
                                    pack_textures.file(path, content);
                                });
                            }
                        });
                        
                        // 修改格式并移动模型
                        var pack_models = models.folder(packName);
                        zip.folder(`assets/${packName}/models/`).forEach(function (path, file){
                            file.async("string").then(function success(content) {
                                let model_name = path.split('/');
                                model_name = model_name[model_name.length-1].replace(".json", "");
                                let bedrock = content.replace("geometry.model", "geometry." + packName + "." + model_name);
                                pack_models.file(path, bedrock);
                            });
                        });
                        
                        // 修改并追加语言文件
                        
                        // 获取模型包信息，注册贴图和模型
                        var packName;

                    }, function (e) {
                        $result.append($("<div>", {
                            "class" : "alert alert-danger",
                            text : "Error reading " + fileList[i].name + ": " + e.message
                        }));
                    });
                }

                // 将信息写入文件
                result.folder("entity").file("maid.entity.json", JSON.stringify(maid_entity, null, '\t'));
                result.folder("render_controllers").file("maid.json", JSON.stringify(render_controller, null, '\t'));

                // 检查语言文件
                let delete_list = [];
                let remains = 0;
                lang_folder.forEach(function (relativePath, file){
                    remains++;
                    file.async("string").then(function success(content) {
                        if(content==="") {
                            delete_list.push(relativePath);
                        }
                        remains--;
                    });
                });

                // 需要在 promise 外删除，但是判断是异步的
                let wait_interval = setInterval(()=>{
                    if(remains <= 0){
                        clearInterval(wait_interval);
                        // 删除文件
                        for(let name of delete_list){
                            result.remove(`lang/${name}`);
                        }
                        // 生成文件并导出
                        result.generateAsync({type:"blob"})
                        .then(function(content) {
                            saveAs(content, "example.zip");
                        });
                        
                        /// 恢复页面交互 ///
                        processing = false;
                        document.getElementById("b_convert").disabled = false;
                        document.getElementById("file").disabled = false;
                    }
                }, 100);
            }

        </script>
        
        <!-- JSZIP https://github.com/Stuk/jszip?tab=readme-ov-file -->

    </body>
</html>

